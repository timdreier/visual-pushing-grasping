#!/usr/bin/env bash
# b5 Taskfile, see https://git.team23.de/build/b5 for details

############################################################
# general commands
############################################################

task:run() {
    xhost +local:docker
    docker:compose up "$@"
}

task:halt() {
    docker:compose down "$@"
}

task:shell() {
    container="$1"
    command="$2"
    additionalArguments="${@:3}"
    docker:container_run "${container:-python}" "${command:-/bin/bash}" ${additionalArguments:-}
}

############################################################
# train commands
############################################################
task:train:blocks() {
  b5 shell vpgt python3 main.py --is_sim --push_rewards --experience_replay --explore_rate_decay --save_visualizations
}

task:train:abc() {
  b5 shell vpgt python3 main.py --is_sim --obj_mesh_dir 'objects/abc_exp' --push_rewards --experience_replay --explore_rate_decay --save_visualizations
}

task:scenario:create() {
  b5 shell vpgt python3 create.py
}

task:scenario:run() {
  objdir="$1"
  exp="$2"
  b5 shell vpgt python3 main.py --is_sim --obj_mesh_dir "objects/${objdir:-blocks}" --num_obj 1 \
    --push_rewards --experience_replay --explore_rate_decay \
    --is_testing --test_preset_cases --test_preset_file "simulation/test-cases/${exp:-test-10-obj-00.txt}" \
    --load_snapshot --snapshot_file "logs/abc/models/snapshot-007600.reinforcement.pth" \
    --save_visualizations
}

############################################################
# evaluation commands
############################################################

############################################################
# maintenance commands
############################################################

task:update() {
  task:assets:download
  docker:update
}

task:install() {
  #task:assets:download
  docker:install
}

############################################################
# assets commands
############################################################
task:assets:download() {
  cd downloads && ./download-weights.sh
}

task:abc:download() {
  task:abc:fetch
  task:abc:extract
  task:abc:scale
}

task:abc:fetch() {
  docker:container_run vpgt -w /usr/src/objects vpgt wget https://archive.nyu.edu/retrieve/120664/abc_full_10k_v00.zip
}

task:abc:extract(){
  docker:container_run -w /usr/src/objects vpgt vpgt unzip abc_full_10k_v00.zip -d abc_tmp
  docker:container_run -w /usr/src/objects/abc_tmp vpgt /bin/bash -c "mv */* . && rm -r 10k"
}

task:abc:scale() {
  docker:container_run -w /usr/src/objects vpgt /bin/bash -c "mkdir -p abc && mkdir -p abc/train && mkdir -p abc/test"
  docker:container_run vpgt /bin/bash -c 'cd /usr/src/objects/abc_tmp/train/512 && for f in *.obj; do python3 ../../../../scale.py "/usr/src/objects/abc_tmp/train/512/${f}" "/usr/src/objects/abc/train/${f}" 0.001; done;';
  docker:container_run vpgt /bin/bash -c 'cd /usr/src/objects/abc_tmp/test/512 && for f in *.obj; do python3 ../../../../scale.py "/usr/src/objects/abc_tmp/test/512/${f}" "/usr/src/objects/abc/test/${f}" 0.001; done;';
}
